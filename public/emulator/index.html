<!--
  ⚠️  AUTO-GENERATED FILE - DO NOT EDIT ⚠️
  
  This file was automatically generated by 'beemi test' command
  Generated: 2025-08-21T20:50:17.050Z
  Source: Beemi Server SDK Manifest
  
  Manual changes to this file will be lost when running 'beemi test'
  To customize emulator behavior, modify your project's manifest.json instead
-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>test1 - iPhone Preview</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .preview-container {
            position: relative;
            width: 100%;
            max-width: 1600px;
            height: 100vh;
            max-height: 800px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 40px;
        }

        .phone-section {
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 1;
        }

        .control-panel {
            width: 320px;
            height: 100%;
            max-height: 800px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            display: flex;
            flex-direction: column;
            gap: 24px;
            overflow-y: auto;
        }

        .control-panel h2 {
            font-size: 24px;
            font-weight: 700;
            color: #333;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .control-section {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .control-section h3 {
            font-size: 14px;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 0;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .control-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            font-size: 16px;
            background: white;
            transition: border-color 0.2s ease;
        }

        .control-input:focus {
            outline: none;
            border-color: #007AFF;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        .username-container {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid rgba(0, 0, 0, 0.1);
            background: white;
            transition: all 0.2s ease;
        }

        .user-avatar:hover {
            border-color: #007AFF;
            transform: scale(1.05);
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            padding: 8px 0;
            user-select: none;
        }

        .checkbox-label input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #667eea;
        }

        .checkbox-text {
            font-size: 14px;
            font-weight: 500;
            color: #333;
        }

        .user-status {
            padding: 8px 12px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            color: #333;
            margin-top: 8px;
        }

        .user-status.user-disabled {
            background: rgba(108, 117, 125, 0.1);
            color: #6c757d;
        }



        .control-button {
            width: 100%;
            padding: 12px 20px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .control-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .control-button:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: #007AFF;
            color: white;
        }

        .btn-primary:hover {
            background: #0056CC;
        }

        .btn-secondary {
            background: #34C759;
            color: white;
        }

        .btn-secondary:hover {
            background: #28A745;
        }

        .gift-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .gift-button {
            padding: 16px;
            border: none;
            border-radius: 16px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            color: white;
        }

        .gift-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }

        .gift-rose {
            background: linear-gradient(135deg, #FF6B6B, #FF8E8E);
        }

        .gift-heart {
            background: linear-gradient(135deg, #FF3B7D, #FF6B9D);
        }

        .gift-diamond {
            background: linear-gradient(135deg, #8B5CF6, #A78BFA);
        }

        .gift-rocket {
            background: linear-gradient(135deg, #3B82F6, #60A5FA);
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(52, 199, 89, 0.1);
            border-radius: 8px;
            font-size: 14px;
            color: #34C759;
            font-weight: 500;
        }

        .status-dot-live {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #34C759;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .virtual-phone {
            position: relative;
            width: 100%;
            height: 100%;
            transform-origin: 0 0;
        }

        .iphone-frame {
            position: relative;
            width: 390px;
            height: 844px;
            background: #000;
            border-radius: 47px;
            padding: 8px;
            box-shadow: 
                0 0 0 2px #1d1d1f,
                0 0 30px rgba(0, 0, 0, 0.3),
                inset 0 0 0 1px rgba(255, 255, 255, 0.1);
        }

        .iphone-screen {
            width: 100%;
            height: 100%;
            background: #fff;
            border-radius: 39px;
            overflow: hidden;
            position: relative;
        }

        .notch {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 164px;
            height: 32px;
            background: #000;
            border-radius: 0 0 20px 20px;
            z-index: 10;
        }

        .status-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 54px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            font-size: 17px;
            font-weight: 600;
            z-index: 5;
        }

        .time {
            color: #000;
        }

        .battery-wifi {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #000;
        }

        .app-header {
            position: absolute;
            top: 54px;
            left: 0;
            right: 0;
            height: 60px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            z-index: 5;
        }

        .back-button {
            color: #007AFF;
            font-size: 17px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .app-title {
            font-size: 17px;
            font-weight: 600;
            color: #000;
        }

        .test-badge {
            background: #34C759;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
        }

        .content-area {
            position: absolute;
            top: 114px;
            left: 0;
            right: 0;
            bottom: 34px;
            display: flex;
            flex-direction: column;
        }

        .top-section {
            height: 40%;
            display: flex;
        }

        .camera-view {
            width: 50%;
            background: linear-gradient(45deg, #1a1a1a, #2d2d2d);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        .camera-placeholder {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(45deg, #4CAF50, #45a049);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        .camera-icon {
            width: 24px;
            height: 24px;
            color: white;
        }

        .camera-status {
            position: absolute;
            bottom: 15px;
            left: 15px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ff4444;
        }

        .live-chat {
            width: 50%;
            background: #f8f9fa;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .chat-header {
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 15px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            font-size: 14px;
            font-weight: 600;
            color: #666;
        }

        .chat-messages {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .chat-message {
            background: white;
            padding: 8px 12px;
            border-radius: 16px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            animation: slideIn 0.3s ease-out;
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }

        .chat-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 1px solid rgba(0, 0, 0, 0.1);
            flex-shrink: 0;
        }

        .chat-content {
            flex: 1;
            min-width: 0;
        }

        .chat-username {
            font-weight: 600;
            color: #007AFF;
            font-size: 12px;
        }

        .chat-text {
            color: #333;
            font-size: 14px;
            margin-top: 2px;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .project-area {
            height: 60%;
            background: #fff;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }

        .webview-container {
            width: 100%;
            height: 100%;
            position: relative;
            background: white;
            overflow: hidden;
        }

        .webview-iframe {
            width: 100%;
            height: 100%;
            border: none;
            background: white;
        }

        .home-indicator {
            position: absolute;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
            width: 134px;
            height: 5px;
            background: #000;
            border-radius: 3px;
        }

        .preview-info {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            font-size: 14px;
            max-width: 250px;
        }

        .preview-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .preview-description {
            color: #666;
            line-height: 1.4;
        }

        @media (max-width: 1400px) {
            .preview-container {
                max-width: 100%;
                gap: 20px;
            }
            
            .control-panel {
                width: 280px;
            }
        }

        @media (max-width: 1200px) {
            .preview-container {
                flex-direction: column;
                justify-content: center;
                gap: 20px;
            }
            
            .control-panel {
                width: 100%;
                max-width: 400px;
                height: auto;
                max-height: none;
                order: -1;
            }
            
            .phone-section {
                flex: none;
            }
        }

        @media (max-width: 768px) {
            .preview-container {
                height: 100vh;
                padding: 10px;
            }
            
            .iphone-frame {
                width: 320px;
                height: 693px;
            }
            
            .preview-info {
                position: relative;
                margin-bottom: 20px;
                left: 0;
                top: 0;
            }
        }
    </style>
</head>
<body>
    <div class="preview-container">
        <div class="preview-info">
            <div class="preview-title">test1 Preview</div>
            <div class="preview-description">Smart preview mode - Automatically matches React Native WebView rendering. Use the control panel to send live interactions to your game.</div>
        </div>
        
        <div class="phone-section">
            <div class="iphone-frame">
                <div class="iphone-screen">
                    <div class="notch"></div>
                    
                    <div class="status-bar">
                        <div class="time">4:19</div>
                        <div class="battery-wifi">
                            <span>📶</span>
                            <span>🔋</span>
                        </div>
                    </div>

                    <div class="app-header">
                        <div class="back-button">← Back</div>
                        <div class="app-title">test1</div>
                        <div class="test-badge">Test</div>
                    </div>

                    <div class="content-area">
                        <div class="top-section">
                            <div class="camera-view">
                                <div class="camera-placeholder">
                                    <svg class="camera-icon" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M12 15.5c1.93 0 3.5-1.57 3.5-3.5S13.93 8.5 12 8.5 8.5 10.07 8.5 12s1.57 3.5 3.5 3.5z"/>
                                        <path d="M20 4h-3.17L15 2H9L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2z"/>
                                    </svg>
                                </div>
                                <div class="camera-status">
                                    <div class="status-dot"></div>
                                    Camera Off
                                </div>
                            </div>

                            <div class="live-chat">
                                <div class="chat-header">Live Chat</div>
                                <div class="chat-messages" id="chatMessages">
                                    <!-- Messages will be added through control panel interactions -->
                                </div>
                            </div>
                        </div>

                        <div class="project-area">
                            <div class="webview-container">
                                <div class="virtual-phone">
                                    <iframe class="webview-iframe" src="/" title="test1"></iframe>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="home-indicator"></div>
                </div>
            </div>
        </div>

        <div class="control-panel">
            <h2>🎮 Stream Controls</h2>
            
            <div class="status-indicator">
                <div class="status-dot-live"></div>
                <span>Live Stream Active</span>
            </div>

            <div class="control-section">
                <h3>User Settings</h3>
                <div class="input-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="userEnabledCheckbox" checked onchange="toggleUserInjection()">
                        <span class="checkbox-text">📝 Inject User Object</span>
                    </label>
                    <div class="user-status" id="userStatus">
                        ✅ User injected: devgamer
                    </div>
                </div>
                <div class="input-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="bridgeAlertsCheckbox" checked onchange="toggleBridgeAlerts()">
                        <span class="checkbox-text">🌉 Show Bridge Alerts</span>
                    </label>
                </div>
            </div>

            <div class="control-section">
                <h3>Chat Messages</h3>
                <div class="input-group">
                    <div class="username-container">
                        <img id="userAvatar" class="user-avatar" src="https://api.dicebear.com/7.x/avataaars/svg?seed=testuser" alt="User Avatar">
                        <input type="text" class="control-input" id="usernameInput" placeholder="Username" value="testuser">
                    </div>
                    <input type="text" class="control-input" id="messageInput" placeholder="Enter chat message...">
                    <button class="control-button btn-primary" onclick="sendChatMessage()">
                        💬 Send Message
                    </button>
                </div>
            </div>

            <div class="control-section">
                <h3>Interactions</h3>
                <button class="control-button btn-secondary" onclick="sendLike()">
                    ❤️ Send Like
                </button>
                <button class="control-button btn-secondary" onclick="sendFollow()">
                    👥 Send Follow
                </button>
            </div>

            <div class="control-section">
                <h3>TikTok Gifts</h3>
                <div class="gift-grid">
                    <button class="gift-button gift-rose" onclick="sendGift('rose')">
                        🌹 Rose
                    </button>
                    <button class="gift-button gift-heart" onclick="sendGift('heart')">
                        💖 Heart
                    </button>
                    <button class="gift-button gift-diamond" onclick="sendGift('diamond')">
                        💎 Diamond
                    </button>
                    <button class="gift-button gift-rocket" onclick="sendGift('rocket')">
                        🚀 Rocket
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Update time every minute
        function updateTime() {
            const now = new Date();
            const timeString = now.getHours().toString().padStart(2, '0') + ':' + 
                             now.getMinutes().toString().padStart(2, '0');
            document.querySelector('.time').textContent = timeString;
        }

        updateTime();
        setInterval(updateTime, 60000);

        // Smart Preview: Match React Native WebView scalesPageToFit behavior
        const iframe = document.querySelector('.webview-iframe');
        
        function applyScaling(iframe) {
            const scale = 0.4; // Match React Native auto-scaling
            
            iframe.style.transform = `scale(${scale})`;
            iframe.style.transformOrigin = '0 0';
            
            // Adjust iframe size to compensate for scaling
            const scaleCompensation = 1 / scale;
            iframe.style.width = `${scaleCompensation * 100}%`;
            iframe.style.height = `${scaleCompensation * 100}%`;
            
            console.log('📱 Applied scaling (matching React Native behavior for non-responsive sites)');
        }
        
        function removeScaling(iframe) {
            iframe.style.transform = 'none';
            iframe.style.width = '100%';
            iframe.style.height = '100%';
            
            console.log('📱 No scaling applied (matching React Native behavior for responsive sites)');
        }
        
        function setupPreviewMatching() {
            if (!iframe) return;
            
            console.log('🔍 Analyzing project for React Native WebView compatibility...');
            
            setTimeout(() => {
                try {
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    if (iframeDoc) {
                        // Check for viewport meta tag
                        const viewportMeta = iframeDoc.querySelector('meta[name="viewport"]');
                        
                        if (!viewportMeta) {
                            console.log('❌ No viewport meta tag found');
                            console.log('🎯 React Native will auto-scale this project');
                            applyScaling(iframe);
                        } else {
                            console.log('✅ Viewport meta tag found:', viewportMeta.content);
                            console.log('🎯 React Native will render this project naturally');
                            removeScaling(iframe);
                        }
                        
                        // Log project analysis
                        const title = iframeDoc.title || 'Untitled Project';
                        console.log(`📊 Project Analysis: "${title}"`);
                        console.log('   - Viewport Meta Tag:', viewportMeta ? '✅ Present' : '❌ Missing');
                        console.log('   - Preview Scaling:', viewportMeta ? '❌ Disabled' : '✅ Enabled');
                        console.log('   - React Native Scaling:', viewportMeta ? '❌ Disabled' : '✅ Enabled');
                        console.log('   - Preview Accuracy: 🎯 Matches React Native WebView');
                        
                    } else {
                        throw new Error('Cannot access iframe document');
                    }
                } catch (error) {
                    console.log('⚠️ Cannot access iframe content (CORS restriction)');
                    console.log('🎯 Applying scaling as fallback (safer assumption for platform)');
                    applyScaling(iframe);
                }
            }, 100);
        }
        
        // Setup preview matching when iframe loads
        iframe.onload = function() {
            setupPreviewMatching();
        };
        
        // Setup immediately if iframe is already loaded
        if (iframe && iframe.complete) {
            setupPreviewMatching();
        }

        // Initialize React Native WebView communication
        setupIframeDebugging();

        // Function to generate avatar URL from username (global scope)
        function generateAvatarUrl(username) {
            const cleanUsername = username.trim() || 'Anonymous';
            return `https://api.dicebear.com/7.x/avataaars/svg?seed=${encodeURIComponent(cleanUsername)}`;
        }

        // Handle Enter key in message input
        document.addEventListener('DOMContentLoaded', function() {
            const messageInput = document.getElementById('messageInput');
            if (messageInput) {
                messageInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        sendChatMessage();
                    }
                });
            }
            
            // Setup username avatar functionality
            const usernameInput = document.getElementById('usernameInput');
            const userAvatar = document.getElementById('userAvatar');
            
            // Function to update avatar
            function updateAvatar() {
                const username = usernameInput.value;
                const avatarUrl = generateAvatarUrl(username);
                userAvatar.src = avatarUrl;
                console.log(`🎭 Avatar updated for username: "${username}"`);
            }
            
            // Add event listener for username changes
            if (usernameInput && userAvatar) {
                usernameInput.addEventListener('input', updateAvatar);
                usernameInput.addEventListener('change', updateAvatar);
                
                // Update avatar on initial load
                updateAvatar();
            }
            
            // Restore user injection checkbox state
            const userEnabledCheckbox = document.getElementById('userEnabledCheckbox');
            const userStatus = document.getElementById('userStatus');
            const savedState = localStorage.getItem('beemi-user-injection-enabled');
            
            if (savedState !== null) {
                const isEnabled = savedState === 'true';
                userEnabledCheckbox.checked = isEnabled;
                
                if (isEnabled) {
                    userStatus.textContent = '✅ User injected: devgamer';
                    userStatus.classList.remove('user-disabled');
                } else {
                    userStatus.textContent = '❌ No user object';
                    userStatus.classList.add('user-disabled');
                }
                
                // Communicate preference to iframe
                window.beemiUserInjectionEnabled = isEnabled;
                console.log('👤 User injection preference restored:', isEnabled);
            } else {
                // Default to enabled
                window.beemiUserInjectionEnabled = true;
                console.log('👤 User injection preference set to default: enabled');
            }
            
            // Restore bridge alerts checkbox state
            const bridgeAlertsCheckbox = document.getElementById('bridgeAlertsCheckbox');
            const savedBridgeState = localStorage.getItem('beemi-bridge-alerts-enabled');
            
            if (savedBridgeState !== null) {
                const isEnabled = savedBridgeState === 'true';
                bridgeAlertsCheckbox.checked = isEnabled;
                
                // Communicate preference to iframe
                window.beemiShowBridgeAlerts = isEnabled;
                console.log('🌉 Bridge alerts preference restored:', isEnabled);
            } else {
                // Default to enabled
                window.beemiShowBridgeAlerts = true;
                console.log('🌉 Bridge alerts preference set to default: enabled');
            }
            
            // Additional setup after DOM is ready
            setTimeout(() => {
                console.log('🚀 Control panel ready - using React Native WebView communication...');
                setupIframeDebugging();
            }, 500);
        });

        // Enhanced SDK Communication
        function sendToWebView(messageData) {
            console.log('📡 Sending to SDK-injected game:', messageData);
            
            const iframe = document.querySelector('.webview-iframe');
            if (!iframe || !iframe.contentWindow) {
                console.log('❌ Iframe not accessible');
                return false;
            }

            try {
                // Access the injected Beemi SDK directly
                const contentWindow = iframe.contentWindow;
                if (contentWindow.beemi && contentWindow.beemi.core && contentWindow.beemi.core.emit) {
                    // Send via Beemi SDK (preferred method) - use room-event with payload wrapper
                    contentWindow.beemi.core.emit('room-event', { payload: messageData });
                    console.log('✅ Message sent via Beemi SDK:', messageData);
                    return true;
                } else {
                    // Fallback: PostMessage for backwards compatibility
                    const messageString = JSON.stringify(messageData);
                    contentWindow.postMessage(messageString, '*');
                    console.log('✅ PostMessage sent (SDK not ready):', messageString);
                    return true;
                }
                
            } catch (error) {
                console.log('❌ Failed to send message:', error);
                return false;
            }
        }

        // Control Panel Functions - Using Beemi SDK Format
        function sendChatMessage() {
            console.log('🔥 sendChatMessage function called');
            const usernameInput = document.getElementById('usernameInput');
            const messageInput = document.getElementById('messageInput');
            const username = usernameInput.value.trim() || 'Anonymous';
            const message = messageInput.value.trim();
            
            if (!message) {
                messageInput.focus();
                return;
            }
            
            console.log('💬 Sending chat message via Beemi SDK:', { username, message });
            
            // Add to visual chat display
            const chatContainer = document.getElementById('chatMessages');
            const messageElement = document.createElement('div');
            messageElement.className = 'chat-message';
            
            // Generate avatar URL for the chat message
            const avatarUrl = generateAvatarUrl(username);
            
            messageElement.innerHTML = `
                <img src="${avatarUrl}" alt="${username}" class="chat-avatar">
                <div class="chat-content">
                    <div class="chat-username">${username}</div>
                    <div class="chat-text">${message}</div>
                </div>
            `;
            
            chatContainer.appendChild(messageElement);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // Remove old messages to prevent overflow
            if (chatContainer.children.length > 12) {
                chatContainer.removeChild(chatContainer.firstChild);
            }
            
            // Clear message input
            messageInput.value = '';
            messageInput.focus();
            
            // Send to game using beemiDev.simulateChat (from top context)
            if (window.beemiDev) {
                // Use the emulator's simulateChat function which includes imageUrl
                window.beemiDev.streams.simulateChat(username, message);
                console.log('✅ Chat message sent via window.beemiDev.streams.simulateChat');
            } else {
                // Retry after a short delay if beemiDev isn't ready yet
                console.log('⏳ beemiDev not ready, retrying in 100ms...');
                setTimeout(() => {
                    if (window.beemiDev) {
                        window.beemiDev.streams.simulateChat(username, message);
                        console.log('✅ Chat message sent via window.beemiDev.streams.simulateChat (delayed)');
                    } else {
                        console.log('❌ beemiDev still not available after retry');
                    }
                }, 100);
            }
        }

        function sendLike() {
            console.log('❤️ Note: React Native doesn\'t send likes to WebView - they stay in RN UI');
            
            // Add to visual chat display only
            const chatContainer = document.getElementById('chatMessages');
            const likeElement = document.createElement('div');
            likeElement.className = 'chat-message';
            likeElement.innerHTML = `
                <div class="chat-username">❤️</div>
                <div class="chat-text">Like received! (RN UI only)</div>
            `;
            
            chatContainer.appendChild(likeElement);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // Remove old messages to prevent overflow
            if (chatContainer.children.length > 12) {
                chatContainer.removeChild(chatContainer.firstChild);
            }
        }

        function sendFollow() {
            console.log('👥 Note: React Native doesn\'t send follows to WebView - they stay in RN UI');
            
            // Add to visual chat display only
            const chatContainer = document.getElementById('chatMessages');
            const followElement = document.createElement('div');
            followElement.className = 'chat-message';
            followElement.innerHTML = `
                <div class="chat-username">👥</div>
                <div class="chat-text">New follower! (RN UI only)</div>
            `;
            
            chatContainer.appendChild(followElement);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // Remove old messages to prevent overflow
            if (chatContainer.children.length > 12) {
                chatContainer.removeChild(chatContainer.firstChild);
            }
        }

        function sendGift(giftType) {
            const giftEmojis = {
                rose: '🌹',
                heart: '💖',
                diamond: '💎',
                rocket: '🚀'
            };
            
            const giftNames = {
                rose: 'Rose',
                heart: 'Heart',
                diamond: 'Diamond',
                rocket: 'Rocket'
            };
            
            console.log('🎁 Note: React Native doesn\'t send gifts to WebView - they stay in RN UI');
            
            // Add to visual chat display only
            const chatContainer = document.getElementById('chatMessages');
            const giftElement = document.createElement('div');
            giftElement.className = 'chat-message';
            giftElement.innerHTML = `
                <div class="chat-username">${giftEmojis[giftType]}</div>
                <div class="chat-text">${giftNames[giftType]} gift! (RN UI only)</div>
            `;
            
            chatContainer.appendChild(giftElement);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // Remove old messages to prevent overflow
            if (chatContainer.children.length > 12) {
                chatContainer.removeChild(chatContainer.firstChild);
            }
        }

        // Toggle user injection
        function toggleUserInjection() {
            const checkbox = document.getElementById('userEnabledCheckbox');
            const userStatus = document.getElementById('userStatus');
            const iframe = document.querySelector('.webview-iframe');
            
            // Update global state first
            window.beemiUserInjectionEnabled = checkbox.checked;
            
            if (checkbox.checked) {
                // Enable user injection
                console.log('👤 User injection enabled - reloading iframe to include user module');
                userStatus.textContent = '✅ User injected: devgamer';
                userStatus.classList.remove('user-disabled');
            } else {
                // Disable user injection
                console.log('👤 User injection disabled - reloading iframe without user module');
                userStatus.textContent = '❌ No user object';
                userStatus.classList.add('user-disabled');
            }
            
            // Store preference
            localStorage.setItem('beemi-user-injection-enabled', checkbox.checked);
            
            // Reload iframe to apply new user module setting
            if (iframe) {
                console.log('🔄 Reloading iframe to apply user injection setting...');
                iframe.src = iframe.src; // Force reload
            }
        }

        // Toggle bridge alerts
        function toggleBridgeAlerts() {
            const checkbox = document.getElementById('bridgeAlertsCheckbox');
            
            // Update global state
            window.beemiShowBridgeAlerts = checkbox.checked;
            
            if (checkbox.checked) {
                console.log('🌉 Bridge alerts enabled - will show alerts for app bridge calls');
            } else {
                console.log('🌉 Bridge alerts disabled - app bridge calls will be silent');
            }
            
            // Store preference
            localStorage.setItem('beemi-bridge-alerts-enabled', checkbox.checked);
        }

        // Setup iframe debugging and SDK communication
        function setupIframeDebugging() {
            const iframe = document.querySelector('.webview-iframe');
            if (!iframe) {
                console.log('❌ Iframe not found');
                return;
            }

            iframe.onload = function() {
                console.log('✅ Game iframe loaded with SDK injection');
                
                // Setup preview matching
                setupPreviewMatching();
                
                // Wait for SDK to initialize, then send test message
                setTimeout(() => {
                    if (window.beemiDev) {
                        window.beemiDev.streams.simulateChat('System', 'Preview connected! Try sending messages from the control panel.');
                        console.log('📡 Test message sent via window.beemiDev.streams.simulateChat');
                    } else {
                        console.log('⚠️ beemiDev not available for test message');
                    }
                }, 2000);
            };

            iframe.onerror = function(error) {
                console.log('❌ Iframe load error:', error);
            };
        }
    </script>

    <script src="beemi-bridge-emulator.js"></script>
</body>
</html> 